<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Refund Management - eBazer Admin</title>
    <link rel="shortcut icon" href="assets/img/logo/favicon.png" type="image/x-icon">

    <!-- CSS links -->
    <link rel="stylesheet" href="assets/css/perfect-scrollbar.css">
    <link rel="stylesheet" href="assets/css/choices.css">
    <link rel="stylesheet" href="assets/css/apexcharts.css">
    <link rel="stylesheet" href="assets/css/quill.css">
    <link rel="stylesheet" href="assets/css/rangeslider.css">
    <link rel="stylesheet" href="assets/css/custom.css">
    <link rel="stylesheet" href="assets/css/main.css">
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body class="antialiased text-slate-500 text-sm font-medium leading-6">

    <div class="tp-main-wrapper bg-slate-100 h-screen" x-data="{ sideMenu: false }">
        <!-- Sidebar (Simplified Copy for Navigation) -->
        <aside class="w-[300px] lg:w-[250px] xl:w-[300px] border-r border-gray overflow-y-scroll sidebar-scrollbar fixed left-0 top-0 h-full bg-white z-50 transition-transform duration-300" :class="sideMenu ? 'translate-x-[0px]' : ' -translate-x-[300px] lg:translate-x-[0]'">
            <div class="">
                <div class="py-4 pb-8 px-8 border-b border-gray h-[78px]">
                    <a href="index.html">
                        <img class="w-[140px]" src="assets/img/logo/logo.svg" alt="">
                    </a>
                </div>
                <div class="px-4 py-5">
                    <ul>
                        <li>
                            <a href="index.html" class="group rounded-md relative text-black text-lg font-medium inline-flex items-center w-full transition-colors ease-in-out duration-300 px-5 py-[9px] mb-2 hover:bg-gray">
                                <span class="inline-block mr-[10px] text-xl">
                                    <svg class="-translate-y-[4px]" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16">
                                        <path fill="currentColor" d="M7,0H4A4,4,0,0,0,0,4V7a4,4,0,0,0,4,4H7a4,4,0,0,0,4-4V4A4,4,0,0,0,7,0ZM9,7A2,2,0,0,1,7,9H4A2,2,0,0,1,2,7V4A2,2,0,0,1,4,2H7A2,2,0,0,1,9,4Z"/>
                                        <path fill="currentColor" d="M20,0H17a4,4,0,0,0-4,4V7a4,4,0,0,0,4,4h3a4,4,0,0,0,4-4V4A4,4,0,0,0,20,0Zm2,7a2,2,0,0,1-2,2H17a2,2,0,0,1-2-2V4a2,2,0,0,1,2-2h3a2,2,0,0,1,2,2Z"/>
                                    </svg>
                                </span>
                                Dashboard
                            </a>
                        </li>
                        <li>
                            <a href="refunds.html" class="bg-themeLight text-theme group rounded-md relative text-lg font-medium inline-flex items-center w-full transition-colors ease-in-out duration-300 px-5 py-[9px] mb-2">
                                <span class="inline-block mr-[10px] text-xl">
                                    <svg class="-translate-y-[4px]" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>
                                </span>
                                Refunds
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="tp-main-content lg:ml-[250px] xl:ml-[300px] w-[calc(100% - 300px)]" x-data="refundsApp()">
            
            <header class="relative z-10 bg-white border-b border-gray border-solid py-5 px-8 pr-8">
                <div class="flex justify-between">
                    <div class="flex items-center space-x-6 lg:space-x-0">
                        <button type="button" class="block lg:hidden text-2xl text-black" x-on:click="sideMenu = ! sideMenu">
                            <span class="sr-only">Menu</span>
                            <svg width="20" height="12" viewBox="0 0 20 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M1 1H19" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                                <path d="M1 6H19" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                                <path d="M1 11H19" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                            </svg>
                        </button>
                    </div>
                    <div class="flex items-center justify-end space-x-6">
                         <!-- User Profile -->
                        <div class="relative w-[70%] flex justify-end items-center" x-data="{ userOption: false }">
                            <button class="relative" type="button" x-on:click="userOption = ! userOption">
                                <img class="w-[40px] h-[40px] rounded-md" src="assets/img/users/user-10.jpg" alt="">
                            </button>
                            <div x-show="userOption" x-on:click.outside="userOption = false" class="absolute w-[280px] top-full right-0 shadow-lg rounded-md bg-white py-5 px-5 z-20">
                                <ul>
                                    <li><a href="login.html" class="px-5 py-2 w-full block hover:bg-gray rounded-md hover:text-theme text-base">Logout</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <div class="body-content px-8 py-8 bg-slate-100">
                <div class="flex justify-between items-end flex-wrap mb-7">
                    <div class="page-title">
                        <h3 class="mb-0 text-4xl">Refund Requests</h3>
                        <p class="text-textBody m-0">Manage customer refund requests</p>
                    </div>
                    <button @click="fetchRefunds()" class="text-theme hover:underline">Refresh Data</button>
                </div>

                <!-- Refunds Table -->
                <div class="bg-white p-8 rounded-md w-full">
                    <div class="overflow-scroll 2xl:overflow-visible">
                        <table class="w-full text-base text-left text-gray-500">
                            <thead class="bg-white">
                                <tr class="border-b border-gray6 text-tiny">
                                    <th class="pr-8 py-3 text-tiny text-text2 uppercase font-semibold">Request ID</th>
                                    <th class="px-3 py-3 text-tiny text-text2 uppercase font-semibold">Order ID</th>
                                    <th class="px-3 py-3 text-tiny text-text2 uppercase font-semibold">User</th>
                                    <th class="px-3 py-3 text-tiny text-text2 uppercase font-semibold">Amount</th>
                                    <th class="px-3 py-3 text-tiny text-text2 uppercase font-semibold">Reason</th>
                                    <th class="px-3 py-3 text-tiny text-text2 uppercase font-semibold">Status</th>
                                    <th class="px-3 py-3 text-tiny text-text2 uppercase font-semibold text-right">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-if="loading">
                                    <tr><td colspan="7" class="text-center py-4">Loading refunds...</td></tr>
                                </template>
                                <template x-if="!loading && refunds.length === 0">
                                    <tr><td colspan="7" class="text-center py-4">No refund requests found.</td></tr>
                                </template>
                                <template x-for="refund in refunds" :key="refund.id">
                                    <tr class="border-b border-gray6 last:border-b-0 text-tiny">
                                        <td class="pr-8 py-5 whitespace-nowrap" x-text="'Ref-' + refund.id.substring(0,6)"></td>
                                        <td class="px-3 py-5 whitespace-nowrap" x-text="refund.order_id"></td>
                                        <td class="px-3 py-5 whitespace-nowrap" x-text="refund.user_email"></td>
                                        <td class="px-3 py-5 whitespace-nowrap" x-text="'$' + refund.amount"></td>
                                        <td class="px-3 py-5" x-text="refund.reason"></td>
                                        <td class="px-3 py-5 whitespace-nowrap">
                                            <span class="px-2 py-1 rounded text-xs" 
                                                  :class="{
                                                      'bg-warning/10 text-warning': refund.status === 'pending',
                                                      'bg-success/10 text-success': refund.status === 'approved',
                                                      'bg-danger/10 text-danger': refund.status === 'rejected'
                                                  }" 
                                                  x-text="refund.status">
                                            </span>
                                        </td>
                                        <td class="px-3 py-5 whitespace-nowrap text-right">
                                            <div x-show="refund.status === 'pending'">
                                                <button @click="openModal(refund)" class="tp-btn px-4 py-1 text-xs bg-theme text-white rounded hover:bg-themeLight hover:text-theme">Review</button>
                                            </div>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Review Modal -->
            <div x-show="isModalOpen" class="fixed inset-0 z-[99] flex items-center justify-center bg-black/50" x-cloak>
                <div class="bg-white rounded-md shadow-lg w-[500px] p-6" @click.outside="isModalOpen = false">
                    <h3 class="text-xl font-semibold mb-4">Review Refund Request</h3>
                    <div class="mb-4 space-y-2">
                        <p><strong>Order ID:</strong> <span x-text="selectedRefund?.order_id"></span></p>
                        <p><strong>Amount:</strong> $<span x-text="selectedRefund?.amount"></span></p>
                        <p><strong>Reason:</strong> <span x-text="selectedRefund?.reason"></span></p>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-1">Admin Note (Optional)</label>
                        <textarea x-model="adminNote" class="w-full border border-gray rounded p-2 text-sm" rows="3" placeholder="Enter reason for approval or rejection..."></textarea>
                    </div>

                    <div class="flex justify-end space-x-3">
                        <button @click="processRefund('rejected')" class="px-4 py-2 border border-danger text-danger rounded hover:bg-danger hover:text-white transition">Reject</button>
                        <button @click="processRefund('approved')" class="px-4 py-2 bg-theme text-white rounded hover:bg-themeDark transition">Approve & Refund</button>
                    </div>
                    <button @click="isModalOpen = false" class="absolute top-4 right-4 text-gray hover:text-black">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>
            </div>

        </div>
    </div>

    <!-- Logic Script -->
    <script>
        function refundsApp() {
            return {
                refunds: [],
                loading: false,
                isModalOpen: false,
                selectedRefund: null,
                adminNote: '',
                
                init() {
                    this.fetchRefunds();
                },

                fetchRefunds() {
                    this.loading = true;
                    const token = localStorage.getItem('token');
                    
                    if (!token) {
                        // For demo purposes if no token, create fake empty state or redirect
                        // window.location.href = 'login.html';
                        console.warn('No token found. Using mock data for demo if fetch fails.');
                    }

                    // Use the REAL API URL
                    fetch('http://localhost:5000/api/admin/refunds', {
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(res => {
                        if (res.status === 401) {
                            alert('Session Expired. Please Login.');
                            window.location.href = 'login.html';
                            return;
                        }
                        return res.json();
                    })
                    .then(data => {
                        this.refunds = data || []; // Expecting array
                        this.loading = false;
                    })
                    .catch(err => {
                        console.error('Error fetching refunds:', err);
                        this.loading = false;
                        // Mock data for UI Testing if API is down or empty
                        if(this.refunds.length === 0) {
                             this.refunds = [
                                { id: 'uuid-1', order_id: 'ORD-1001', user_email: 'customer@example.com', amount: 150.00, reason: 'Damaged item', status: 'pending' },
                                { id: 'uuid-2', order_id: 'ORD-1005', user_email: 'john@example.com', amount: 45.99, reason: 'Wrong size', status: 'approved' }
                            ];
                        }
                    });
                },

                openModal(refund) {
                    this.selectedRefund = refund;
                    this.adminNote = '';
                    this.isModalOpen = true;
                },

                processRefund(action) {
                    const token = localStorage.getItem('token');
                    const url = `http://localhost:5000/api/admin/refunds/${this.selectedRefund.id}`;

                    fetch(url, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            status: action,
                            admin_note: this.adminNote
                        })
                    })
                    .then(res => res.json())
                    .then(data => {
                        alert(`Refund ${action} successfully!`);
                        this.isModalOpen = false;
                        this.fetchRefunds(); // Refresh list
                    })
                    .catch(err => {
                        console.error('Error processing refund:', err);
                        alert('Failed to process refund. Check console.');
                    });
                }
            }
        }
    </script>
    <script src="assets/js/main.js"></script>
</body>
</html>
